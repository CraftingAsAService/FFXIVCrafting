function unique(a){return $.grep(a,function(b,c){return c==$.inArray(b,a)})}var equipment={options:{job:job,level:level,craftable_only:craftable_only,rewardable_too:rewardable_too,level_range:3,viewport_differential:0,boring_stats:!1},init:function(){$(".bootswitch").bootstrapSwitch({onSwitchChange:function(){$(this).closest("form").submit()}}),$.fn.inlineStyle=function(a){return this.prop("style")[$.camelCase(a)]},$(document).on("viewportchanged",equipment.viewport_changed),equipment.viewport_changed(),equipment.table_events(),equipment.page_events(),equipment_tour.init()},viewport_changed:function(){equipment.slim($("#toggle-slim").bootstrapSwitch("state"))},cell_events:function(){equipment.mark_upgrades(),equipment.same_cell_heights(),"undefined"!=typeof XIVDBTooltips&&XIVDBTooltips.initialize(),$("#gear tbody td:visible .td-navigation .item-next").on("click",function(a){a.preventDefault();var b=$(this).closest("td");b.trigger("mouseleave");var c=b.find(".items"),d=c.find(".item.active"),e=d.next();1!=e.length&&(e=c.children(":first-child")),d.removeClass("active").addClass("hidden"),e.removeClass("hidden").addClass("active"),b.trigger("mouseenter");var f=parseInt(b.find(".td-navigation .total").html()),g=b.find(".td-navigation .current"),h=parseInt(g.html());h++,h>f&&(h=1),g.html(h),equipment.mark_cannot_equips(),equipment.stat_summary(b),$("#gear td:visible .role-wrap").css("height","inherit"),equipment.same_cell_heights()}),$("#gear tbody td:visible").on("mouseenter",equipment.compare),$("#gear tbody td:visible").on("mouseleave",equipment.uncompare),$("[rel=tooltip]").tooltip(global.tooltip_options),$("#gear tbody tr:first-child td:visible").each(function(){equipment.stat_summary($(this))})},table_events:function(){equipment.cell_events(),$(".previous-gear").click(function(){var a=$(this);if(!a.hasClass("disabled")){$(".previous-gear, .next-gear").addClass("disabled");var b=equipment.options.level-1;if(1>b)return void $(".previous-gear, .next-gear").removeClass("disabled");equipment.options.level=b,$("td[data-level="+b+"]").length>0?(equipment.column_display(),equipment.fix_rows(),equipment.mark_upgrades(),equipment.same_cell_heights(),b-1>0&&0==$("td[data-level="+(b-1)+"]").length?equipment.load_column(b-1,"Pre"):$(".previous-gear, .next-gear").removeClass("disabled")):equipment.load_column(b)}}),$(".next-gear").click(function(){var a=$(this);if(!a.hasClass("disabled")){$(".previous-gear, .next-gear").addClass("disabled");var b=equipment.options.level+1;if(b>max_level-2)return void $(".previous-gear, .next-gear").removeClass("disabled");equipment.options.level=b,$("td[data-level="+(b+equipment.options.level_range-1)+"]").length>0?(equipment.column_display(),equipment.fix_rows(),equipment.mark_upgrades(),equipment.same_cell_heights(),b+equipment.options.level_range<=max_level&&0==$("td[data-level="+(b+equipment.options.level_range-1)+"]").length?equipment.load_column(b+equipment.options.level_range-1,"Pre"):$(".previous-gear, .next-gear").removeClass("disabled")):equipment.load_column(b+equipment.options.level_range-1)}})},slim:function(a){$("#gear")[(a?"add":"remove")+"Class"]("slim"),$("td:visible .role-wrap").css("height","inherit"),equipment.options.level_range=a?4:3,equipment.options.viewport_differential="mobile"==viewport.current?3-(a?0:1):0,equipment.column_display(),equipment.same_cell_heights()},same_cell_heights:function(){$("#gear tbody tr").each(function(){var a=$(this),b=0;$("td:visible .role-wrap",a).each(function(){var a=$(this),c=0;""!=$(this).inlineStyle("height")&&(c=16);var d=a.innerHeight()-c;d>b&&(b=d)}),$("td:visible .role-wrap",a).height(b)})},mark_upgrades:function(){$("#gear tbody td:visible").each(function(){var a=$(this),b=a.data("level"),c=a.closest("tr").find("td[data-level="+(b-1)+"]");if(0!=c.length||1==b){var d=a.find(".item:first-child").data("itemIlvl"),e=c.find(".item:first-child").data("itemIlvl");a[(d==e?"remove":"add")+"Class"]("upgrade")}}),equipment.mark_cannot_equips()},mark_cannot_equips:function(){$("#gear tbody td.cannot-equip").removeClass("cannot-equip"),$(".why-cannot-equip").remove(),$('#gear tbody td:visible .item.active:not([data-cannot-equip=""])').each(function(){for(var a=$(this),b=$(".name-box a",a).html(),c=$.isNumeric(a.data("cannotEquip"))?[]:a.data("cannotEquip").split(","),d=a.closest("td"),e=d.data("level"),f=0;f<c.length;f++){var g=$(".role-"+c[f].capitalize().replace(/ /,"-")+"[data-level="+e+"]");g.append('<div class="why-cannot-equip">'+b+"<br>Cannot equip gear to "+c[f].capitalize()+"</div>"),g.addClass("cannot-equip")}equipment.stat_summary(d)})},load_column:function(a,b){return"undefined"==typeof b&&(b=""),"mobile"==viewport.current&&(b="Pre"),parseInt(a)>max_level?void $(".previous-gear, .next-gear").removeClass("disabled"):void $.ajax({url:"/equipment/load",type:"post",dataType:"json",data:{job:equipment.options.job,level:a,craftable_only:equipment.options.craftable_only,rewardable_too:equipment.options.rewardable_too},beforeSend:function(){global.noty({type:"warning",text:b+"Loading Level "+a})},success:function(b){$.each(b.gear,function(b,c){$('#gear .role-row[data-role="'+b+'"]').append(c[a])}),$("#gear thead tr").append(b.head[a]),$("#gear tfoot tr").append(b.foot[a]),equipment.column_display(),equipment.fix_rows(),equipment.cell_events(),$(".previous-gear, .next-gear").removeClass("disabled")}})},fix_rows:function(){$("#gear tr").each(function(){var a=$(this),b=a.find("th:visible, td:visible").get();b.sort(function(a,b){var c=parseInt($(a).data("level")),d=parseInt($(b).data("level"));return d>c?-1:c>d?1:0});for(var c=0;c<b.length;c++)b[c].parentNode.appendChild(b[c])})},column_display:function(){var a=equipment.options.level;a>max_level-equipment.options.level_range+1&&(a=max_level-equipment.options.level_range+1),$("#gear td[data-level]").addClass("hidden"),$("#gear th[data-level]").addClass("hidden");for(var b=a;b<equipment.options.level+equipment.options.level_range-equipment.options.viewport_differential;b++)$("#gear td[data-level="+b+"]").removeClass("hidden"),$("#gear th[data-level="+b+"]").removeClass("hidden")},compare:function(){var a=$(this),b=a.find(".item.active .stats-box"),c=a.prev("td").find(".item.active .stats-box");b.find(".stat").each(function(){var a=$(this),b=c.find('.stat[data-stat="'+a.data("stat")+'"]');if(0==b.length)$("span",a).html(a.data("amount")).addClass("text-success");else{var d=parseInt(a.data("amount"))-parseInt(b.data("amount"));$("span",a).html(d).addClass("text-"+(d>0?"success":0>d?"danger":"warning"))}})},uncompare:function(){$(this).find(".stats-box .stat").each(function(){var a=$(this);$("span",a).html(a.data("amount")).removeClass("text-success").removeClass("text-danger").removeClass("text-warning")})},stat_summary:function(a){var b=$(a).data("level"),c=[],d=[];$("#gear tbody tr td[data-level="+b+']:not("cannot-equip")').each(function(){$(this).find(".item.active .nq.stat").each(function(){var a=$(this),b=a.data();a.hasClass("hidden")&&(d[d.length]=b.statImage),"undefined"==typeof c[b.statImage]&&(c[b.statImage]=0),c[b.statImage]+=b.amount})});var e=$("#gear tfoot tr:first-child th[data-level="+b+"] .stats-box");e.html("");for(var f in c){var g=c[f],h=$("<div>");d.indexOf(f)>-1&&h.addClass("hidden"),h.addClass("col-sm-6").addClass("text-center").addClass("stat").attr("data-stat",f).attr("data-amount",g);var i=$("<span>");i.html("+"+g+" &nbsp; ");var j=$("<img>");j.attr("src","/img/stats/"+f+".png").addClass("stat-icon").attr("rel","tooltip").attr("title",f),h.append(i),h.append(j),e.append(h)}},all_stats:function(){$("#gear td:visible .stats-box .boring").toggleClass("hidden"),$("#gear td:visible .role-wrap").css("height","inherit"),equipment.same_cell_heights()},page_events:function(){$("#toggle-slim").on("switchChange.bootstrapSwitch",function(a,b){equipment.slim(b),$("html, body").animate({scrollTop:$("#table-options").offset().top},"slow")}),$("#toggle-slim").bootstrapSwitch("state")&&(equipment.options.level_range=4),$("#toggle-all-stats").on("switchChange.bootstrapSwitch",function(a,b){equipment.options.boring_stats=b,equipment.all_stats(),$("html, body").animate({scrollTop:$("#table-options").offset().top},"slow")})}},equipment_tour={tour:null,first_run:!0,init:function(){var a=$("#start_tour");equipment_tour.tour=new Tour({orphan:!0,onStart:function(){return a.addClass("disabled",!0)},onEnd:function(){return a.removeClass("disabled",!0)}}),a.click(function(a){a.preventDefault(),$("#toggle-slim").bootstrapSwitch("state")&&$("#toggle-slim").bootstrapSwitch("toggleState"),1==equipment_tour.first_run&&equipment_tour.build(),$(this).hasClass("disabled")||equipment_tour.tour.restart()})},build:function(){var a=$("#gear td:visible.upgrade")[0],b=$(".item.active .stats-box .stat",a)[0],c=$("#gear td:visible .item.active .crafted_by")[0];equipment_tour.tour.addSteps([{element:a,title:"Upgrade",content:"Boxes with a border and circle icon indicate an upgrade."},{element:b,title:"Stats",content:"These are the stats for the item.  Hovering on them will tell you how much of an upgrade it is from the previous item.",placement:"bottom"},{element:c,title:"Crafted By & Buyable",content:"<p>This item can be crafted by the class indicated. <strong>Clicking on it will add that item to your Crafting Cart!</strong></p><p>The coins indicate that you can buy them from a vendor.</p>"},{element:".previous-gear",title:"Level Traversing",content:"Click this bar (and the one on the right) to decrease (or increase) the gear level."},{element:"#toggle-slim",title:"Slim Mode",content:"If you don't want to see stats, turn this mode on.",placement:"top"},{element:"#toggle-all-stats",title:"Boring Stats",content:"Boring stats are hidden by default.  Use this option to turn them on.  An example of a boring stat would be Magic Damage to a Disciple of War class.",placement:"top"}]),equipment_tour.first_run=!1}};$(equipment.init);