var crafting={init:function(){crafting.events(),crafting_tour.init()},events:function(){$("#toggle-crystals").click(crafting.toggle_crystals),"off"==localStorage.getItem("config:toggle-crystals")&&$("#toggle-crystals").trigger("click"),$("#obtain-these-items .collapsible").click(function(){var a=$(this);a.find("i").toggleClass("glyphicon-chevron-down").toggleClass("glyphicon-chevron-up");var b=$(this).closest("tbody"),c=b.find("tr:not(:first-child)");c.toggleClass("hidden")}),$(".needed input").change(function(){var a=$(this),b=a.closest("#CraftingList-section").length>0;crafting.recalculate_all(b),a.closest("tr").find(".total").html(a.val())}),$("input.obtained").change(function(){var a=$(this).closest("#CraftingList-section").length>0;return crafting.recalculate_all(a)}),$(".obtained-ok").click(function(){var a=$(this).closest("tr"),b=$("td.total",a).html();$("input.obtained",a).val(b).trigger("change")}),$("#clear-localstorage").click(crafting.clear_localstorage),crafting.set_localstorage_id(),crafting.restore_localstorage(),crafting.init_reagents(),crafting.recalculate_all(!0),$("#map_all, #map_remaining").click(function(a){a.preventDefault()}),$("#csv_download").click(function(a){a.preventDefault();var b=[["Item","iLevel","Yields","Needed","Purchase"]];$("tr.reagent").each(function(){var a=[],c=$(this);a.push(c.find("span.name").text()),a.push(c.data("ilvl")||c.find(".ilvl").text().replace(/\s|\n/gi,"")||"-"),a.push(c.data("yields")),a.push(c.find(".total").text()),a.push(c.find(".vendors").length?c.find(".vendors").text().replace(/\s|\n/gi,"")+" gil":""),b.push(a)});var c=$(".csv-filename").text().trim()+" "+$(".csv-filename + h2").text().trim();global.exportToCsv(c+".csv",b)})},toggle_crystals:function(){var a=$(this),b=a.closest("th").attr("colspan"),c=a.closest("tr");if(a.hasClass("off"))c.next("tr.crystals").remove(),$("[data-item-category=Crystal]").each(function(){$(this).show()}),a.removeClass("off"),localStorage.removeItem("config:toggle-crystals");else{var d=$("<th>",{colspan:b,"class":"text-center"}),e=$("<tr>",{"class":"crystals hidden"}).append(d);c.after(e),$("[data-item-category=Crystal]").each(function(){var a=$(this),b=a.data("itemId"),c=a.find(".name").first().html(),e=a.find("img").first().clone(!0,!0),f=parseInt(a.find(".total").html()),g=0==f?"success":"primary";a.hide(),e.removeClass("margin-right");var h=$("<span>",{id:"crystal-"+b,"class":"crystal-container",html:'<span class="label label-'+g+'">'+f+"</span>",rel:"tooltip",title:c});h.tooltip(global.tooltip_options),h.append(e),d.append(h)}),e.removeClass("hidden"),a.addClass("off"),localStorage.setItem("config:toggle-crystals","off")}},localstorage_id:null,set_localstorage_id:function(){crafting.localstorage_id="page:"+encodeURIComponent(window.location.pathname),null!=crafting.localstorage_id.match("from-list")&&(crafting.localstorage_id=$("#CraftingList-section").find(".reagent").map(function(){return $(this).data("itemId")+"_"+$(this).find(".needed input").val()}).get().sort().join("|"))},clear_localstorage:function(a){a.preventDefault(),localStorage.removeItem(crafting.localstorage_id),location.reload()},restore_localstorage:function(){var a=JSON.parse(localStorage.getItem(crafting.localstorage_id));null!==a&&($(".reagent").not(".exempt").each(function(){var b=$(this),c=b.data("itemId"),d=b.find("input.obtained");"undefined"!=typeof a.progress.hasOwnProperty("item"+c)&&a.progress["item"+c]>0&&d.val(a.progress["item"+c])}),$(".reagent.exempt").each(function(){var b=$(this),c=b.data("itemId"),d=b.find(".needed input"),e=b.find("input.obtained");"undefined"!=typeof a.contents.hasOwnProperty("needed"+c)&&a.contents["needed"+c]>0&&d.val(a.contents["needed"+c]),"undefined"!=typeof a.contents.hasOwnProperty("item"+c)&&a.contents["item"+c]>0&&e.val(a.contents["item"+c])}))},store_localstorage:function(){var a={progress:{},contents:{}};$(".reagent").not(".exempt").each(function(){var b=$(this),c=b.data("itemId"),d=b.find("input.obtained"),e=parseInt(d.val());e>0&&(a.progress["item"+c]=e)}),$(".reagent.exempt").each(function(){var b=$(this),c=b.data("itemId"),d=b.find(".needed input"),e=b.find("input.obtained"),f=parseInt(d.val()),g=parseInt(e.val());f>0&&(a.contents["needed"+c]=f),g>0&&(a.contents["item"+c]=g)}),localStorage.setItem(crafting.localstorage_id,JSON.stringify(a))},reagents:[],init_reagents:function(){$(".reagent").each(function(){var a=$(this),b={name:a.find('a[href^="http"]').text().trim(),exempt:a.hasClass("exempt"),item_id:a.data("itemId"),yields:a.data("yields"),reagents:[],needed:0,obtained:0,total:0,remainder:0,elements:{row:a,needed:$("td.needed span",a).length>0?$("td.needed span",a):$("td.needed input",a),obtained:$("input.obtained",a),total:$("td.total",a)}};if(requires=a.data("requires").split("&"),b.exempt&&$("tr.reagent:not(.exempt)[data-item-id="+b.item_id+"]").length>0&&(requires[requires.length]="1x"+b.item_id),1==requires.length&&""==requires[0])b.reagents=null;else for(var c=0;c<requires.length;c++){var d=requires[c].split("x");b.item_id!=d[1]&&(b.reagents[b.reagents.length]={item_id:d[1],quantity:parseInt(d[0])})}crafting.reagents[crafting.reagents.length]=b})},recalculate_all:function(a){for(var b=0;b<crafting.reagents.length;b++){var c=crafting.reagents[b];if(c.obtained=parseInt(c.elements.obtained.val()),c.total=0,c.remainder=0,1==c.exempt){c.needed=parseInt(c.elements.needed.val()),c.elements.obtained.attr("max",c.needed),c.elements.row[(c.needed-c.obtained==0?"add":"remove")+"Class"]("success");var d=Math.ceil(Math.max(c.needed-c.obtained,0)/c.yields);crafting.oven(c,d,a)}else c.needed=0}for(var b=0;b<crafting.reagents.length;b++){var c=crafting.reagents[b];if(1!=c.exempt&&null!=c.reagents){var d=Math.ceil(Math.min(0-c.obtained,0)/c.yields);crafting.oven(c,d,a)}}for(var b=0;b<crafting.reagents.length;b++){var c=crafting.reagents[b];if(1!=c.exempt){if(c.needed=c.needed-c.obtained,c.needed<0){c.obtained+=c.needed;var e=Math.ceil(c.obtained/c.yields)*c.yields;c.elements.obtained.val(0>e?0:e),c.needed=0}var f=Math.ceil(c.needed/c.yields)*c.yields,g=Math.ceil(c.total/c.yields)*c.yields;c.elements.needed.html(f),c.elements.obtained.attr("max",g),c.elements.total.html(c.total<0?0:Math.ceil(c.total/c.yields)*c.yields),c.elements.row[(0==c.needed?"add":"remove")+"Class"]("success")}}crafting.store_localstorage(),$("tr.crystals").length>0&&$("[data-item-category=Crystal]").each(function(){var a=$(this),b=a.data("itemId"),c=parseInt(a.find(".total").html()),d=$("#crystal-"+b).find(".label");d.html(c),d.toggleClass("label-primary",0!=c),d.toggleClass("label-success",0==c)})},oven:function(a,b,c){if(null!=a.reagents)a:for(var d=0;d<a.reagents.length;d++)for(var e=a.reagents[d],f=0;f<crafting.reagents.length;f++){var g=crafting.reagents[f];if(g.item_id==e.item_id){var h=b*e.quantity;if(g.needed+=h,g.total+=h,g.remainder>0){var i=Math.min(h,g.remainder);h-=i,g.remainder-=i}var j=Math.ceil(h/g.yields);g.remainder+=j*g.yields-h,crafting.oven(g,j,c);continue a}}}},crafting_tour={tour:null,first_run:!0,init:function(){var a=$("#start_tour");crafting_tour.tour=new Tour({orphan:!0,onStart:function(){return a.addClass("disabled",!0)},onEnd:function(){return a.removeClass("disabled",!0)}}),a.click(function(a){a.preventDefault(),$("#toggle-slim").bootstrapSwitch("status")&&$("#toggle-slim").bootstrapSwitch("setState",!1),1==crafting_tour.first_run&&crafting_tour.build(),$(this).hasClass("disabled")||crafting_tour.tour.restart()})},build:function(){crafting_tour.tour.addSteps([{element:"#CraftingList-section",title:"Recipe List",content:"The list at the bottom is your official Recipe List.  You will be making these items.",placement:"top"},{element:"#Gathered-section tr:first-child",title:"Gathered Section",content:"Items you can gather with MIN, BTN or FSH will appear in the Gathered Section.",placement:"bottom"},{element:"#Bought-section tr:first-child",title:"Bought Section",content:"Items you cannot gather will be thrown into the Bought Section.",placement:"bottom"},{element:"#Other-section tr:first-child",title:"Other Section",content:"Items that cannot be bought or gathered show up in the Other Section.  Most likely these will involve monster drops.",placement:"bottom"},{element:"#PreRequisiteCrafting-section tr:first-child",title:"Pre-Requisite Crafting",content:"Why buy what you can craft?  The Crafted Section contains items necessary for your main recipes to finish.  The previous sections will already contain the sub items required.",placement:"bottom"},{element:"#self-sufficient-form",title:"Self Sufficient",content:"By default it assumes you want to be Self Sufficient.  Turning this option off will eliminate the Gathering and Crafting aspect and appropriately force the items into either Bought or Other.",placement:"top"},{element:"#leveling-information",title:"Leveling Information",content:"Pay attention to the Leveling Information box as it will give you a heads up as to what your next quest turn ins will require.",placement:"top"}]),crafting_tour.first_run=!1}};$(crafting.init);