var crafting={init:function(){$("#toggle-crystals").click(crafting.toggle_crystals),"off"==localStorage.getItem("config:toggle-crystals")&&$("#toggle-crystals").trigger("click"),$("#obtain-these-items .collapsible").click(function(){$(this).find("i").toggleClass("glyphicon-chevron-down").toggleClass("glyphicon-chevron-up"),$(this).closest("tbody").find("tr:not(:first-child)").toggleClass("hidden")}),$(".needed input").change(function(){var e=$(this);crafting.recalculateAll(),e.closest("tr").find(".total").html(e.val())}),$("input.obtained").change(function(){return crafting.recalculateAll()}),$(".obtained-ok").click(function(){var e=$(this).closest("tr"),t=$("td.total",e).html();$("input.obtained",e).val(t).trigger("change")}),$("#clear-localstorage").click(crafting.clear_localstorage),crafting.set_localstorage_id(),crafting.restore_localstorage(),crafting.init_reagents(),crafting.recalculateAll(),$("#map_all, #map_remaining").click(function(e){e.preventDefault()}),$("#csv_download").click(function(e){e.preventDefault();var t=[["Item","iLevel","Yields","Needed","Purchase"]];$("tr.reagent").each(function(){var e=[],a=$(this);e.push($.trim(a.find("a.name").text())),e.push(a.data("ilvl")||a.find(".ilvl").text().replace(/\s|\n/gi,"")||"-"),e.push(a.data("yields")),e.push(a.find(".total").text()),e.push(a.find(".vendors").length?a.find(".vendors").text().replace(/\s|\n/gi,"")+" gil":""),t.push(e)});var a=$(".csv-filename").text().trim()+" "+$(".csv-filename + h2").text().trim();global.exportToCsv(a+".csv",t)})},toggle_crystals:function(){var e=$(this),t=e.closest("th").attr("colspan"),a=e.closest("tr");if(e.hasClass("off"))a.next("tr.crystals").remove(),$("[data-item-category=Crystal]").each(function(){$(this).show()}),e.removeClass("off"),localStorage.removeItem("config:toggle-crystals");else{var n=$("<th>",{colspan:t,class:"text-center"}),i=$("<tr>",{class:"crystals hidden"}).append(n);a.after(i),$("[data-item-category=Crystal]").each(function(){var e=$(this),t=e.data("itemId"),a=e.find(".name").first().html(),i=e.find("img").first().clone(!0,!0),r=parseInt(e.find(".total").html()),l=0==r?"success":"primary";e.hide(),i.removeClass("margin-right");var s=$("<span>",{id:"crystal-"+t,class:"crystal-container",html:'<span class="label label-'+l+'">'+r+"</span>",rel:"tooltip",title:a});s.tooltip(global.tooltip_options),s.append(i),n.append(s)}),i.removeClass("hidden"),e.addClass("off"),localStorage.setItem("config:toggle-crystals","off")}},localstorage_id:null,set_localstorage_id:function(){crafting.localstorage_id="page:"+encodeURIComponent(window.location.pathname),null!=crafting.localstorage_id.match("from-list")&&(crafting.localstorage_id=$("#CraftingList-section").find(".reagent").map(function(){return $(this).data("itemId")+"_"+$(this).find(".needed input").val()}).get().sort().join("|"))},clear_localstorage:function(e){e.preventDefault(),localStorage.removeItem(crafting.localstorage_id),location.reload()},restore_localstorage:function(){var e=JSON.parse(localStorage.getItem(crafting.localstorage_id));null!==e&&($(".reagent").not(".exempt").each(function(){var t=$(this),a=t.data("itemId"),n=t.find("input.obtained");void 0!==e.progress.hasOwnProperty("item"+a)&&e.progress["item"+a]>0&&n.val(e.progress["item"+a])}),$(".reagent.exempt").each(function(){var t=$(this),a=t.data("itemId"),n=t.find(".needed input"),i=t.find("input.obtained");void 0!==e.contents.hasOwnProperty("needed"+a)&&e.contents["needed"+a]>0&&n.val(e.contents["needed"+a]),void 0!==e.contents.hasOwnProperty("item"+a)&&e.contents["item"+a]>0&&i.val(e.contents["item"+a])}))},store_localstorage:function(){var e={progress:{},contents:{}};$(".reagent").not(".exempt").each(function(){var t=$(this),a=t.data("itemId"),n=t.find("input.obtained"),i=parseInt(n.val());i>0&&(e.progress["item"+a]=i)}),$(".reagent.exempt").each(function(){var t=$(this),a=t.data("itemId"),n=t.find(".needed input"),i=t.find("input.obtained"),r=parseInt(n.val()),l=parseInt(i.val());r>0&&(e.contents["needed"+a]=r),l>0&&(e.contents["item"+a]=l)}),localStorage.setItem(crafting.localstorage_id,JSON.stringify(e))},reagents:[],init_reagents:function(){$(".reagent").each(function(){var e=$(this),t={name:e.find('a[href^="http"]').text().trim(),exempt:e.hasClass("exempt"),item_id:e.data("itemId"),yields:e.data("yields"),reagents:[],needed:0,obtained:0,total:0,remainder:0,elements:{row:e,needed:$("td.needed span",e).length>0?$("td.needed span",e):$("td.needed input",e),obtained:$("input.obtained",e),total:$("td.total",e)}};if(requires=e.data("requires").split("&"),t.exempt&&$("tr.reagent:not(.exempt)[data-item-id="+t.item_id+"]").length>0&&(requires[requires.length]="1x"+t.item_id),1==requires.length&&""==requires[0])t.reagents=null;else for(var a=0;a<requires.length;a++){var n=requires[a].split("x");t.item_id!=n[1]&&(t.reagents[t.reagents.length]={item_id:n[1],quantity:parseInt(n[0])})}crafting.reagents[crafting.reagents.length]=t}),$.each($("#PreRequisiteCrafting-section .reagent").get().reverse(),function(){for(var e=$(this),t=e.data("requires").split("&"),a=0;a<t.length;a++){var n=t[a].split("x"),i=$("#PreRequisiteCrafting-section .reagent[data-item-id="+n[1]+"]");i.length>0&&i.insertBefore(e)}})},recalculateAll:function(){for(var e=0;e<crafting.reagents.length;e++){var t=crafting.reagents[e];if(t.obtained=parseInt(t.elements.obtained.val()),t.total=0,t.remainder=0,1==t.exempt){t.needed=parseInt(t.elements.needed.val()),t.elements.obtained.attr("max",t.needed),t.elements.row[(t.needed-t.obtained==0?"add":"remove")+"Class"]("success");var a=Math.ceil(Math.max(t.needed-t.obtained,0)/t.yields);crafting.oven(t,a)}else t.needed=0}for(var e=0;e<crafting.reagents.length;e++){var t=crafting.reagents[e];if(1!=t.exempt&&null!=t.reagents){var a=Math.ceil(Math.min(0-t.obtained,0)/t.yields);crafting.oven(t,a)}}for(var e=0;e<crafting.reagents.length;e++){var t=crafting.reagents[e];if(1!=t.exempt){if(t.needed=t.needed-t.obtained,t.needed<0){t.obtained+=t.needed;var n=Math.ceil(t.obtained/t.yields)*t.yields;t.elements.obtained.val(n<0?0:n),t.needed=0}var i=Math.ceil(t.needed/t.yields)*t.yields,r=Math.ceil(t.total/t.yields)*t.yields;t.elements.needed.html(i),t.elements.obtained.attr("max",r),t.elements.total.html(t.total<0?0:Math.ceil(t.total/t.yields)*t.yields),t.elements.row.toggleClass("success",0==t.needed)}}crafting.store_localstorage(),$("tr.crystals").length>0&&$("[data-item-category=Crystal]").each(function(){var e=$(this),t=e.data("itemId"),a=parseInt(e.find(".total").html()),n=$("#crystal-"+t).find(".label");n.html(a),n.toggleClass("label-primary",0!=a),n.toggleClass("label-success",0==a)}),$("tr.reagent.success").each(function(){var e=$(this),t=e.closest("tbody");e.appendTo(t)})},oven:function(e,t){if(null!=e.reagents)e:for(var a=0;a<e.reagents.length;a++)for(var n=e.reagents[a],i=0;i<crafting.reagents.length;i++){var r=crafting.reagents[i];if(r.item_id==n.item_id){var l=t*n.quantity;if(r.needed+=l,r.total+=l,r.remainder>0){var s=Math.max(0,Math.min(l,r.remainder));l-=s,r.remainder-=s}var o=Math[l<0?"floor":"ceil"](l/r.yields);r.remainder+=o*r.yields-l,crafting.oven(r,o);continue e}}}};$(crafting.init);